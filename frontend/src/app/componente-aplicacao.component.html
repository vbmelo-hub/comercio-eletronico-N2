<div class="layout">
  <div class="shell">
    <header class="top-hero">
      <nav class="navbar ribbon-bar">
        <div class="brand">
          <div class="brand-mark">PH</div>
          <div>
            <p class="eyebrow">PetHouse</p>
            <strong>Cuidado e conveniência</strong>
          </div>
        </div>

        <div class="search-wrap">
          <input
            class="search-input"
            placeholder="Digite sua busca (ex.: escova de pelos)"
            [(ngModel)]="searchTerm"
            (keyup.enter)="onSearch(searchTerm)"
          >
          <button class="search-btn" (click)="onSearch(searchTerm)">Buscar</button>
        </div>

        <div class="nav-icons">
          <button class="icon-btn" (click)="setTab('catalog')" title="Catálogo">Catálogo</button>
          <button class="icon-btn" (click)="setTab('orders')" title="Histórico">Histórico</button>
          <button class="icon-btn" (click)="setTab('cart')" title="Carrinho">Carrinho</button>
          <button class="icon-btn" *ngIf="isAdmin" (click)="setTab('admin')" title="Administração">Administração</button>
          <button class="icon-btn" *ngIf="!user" (click)="openLoginModal()" title="Entrar">Entrar</button>
          <button class="icon-btn" *ngIf="user" (click)="logout()" title="Sair">Logout</button>
        </div>
      </nav>
      <div class="color-band"></div>
    </header>

    <div class="status" *ngIf="statusMessage">{{statusMessage}}</div>
    <div class="toast" *ngIf="toast" [class.error]="toast.type==='error'">{{toast.message}}</div>

    <main class="content">
      
      <!-- CATALOGO -->
      <section *ngIf="activeTab==='catalog'" class="panel catalog-panel">
        <div class="panel-head">
          <div>
            <p class="eyebrow">Produtos</p>
            <h2>Escolha pelo pet</h2>
          </div>
          <div class="pill muted">Itens disponíveis: {{products.length}}</div>
        </div>

        <app-filtros-catalogo
          [categories]="categories"
          [petFilter]="petFilter"
          [categoryFilter]="categoryFilter"
          (petChange)="onPetChange($event)"
          (categoryChange)="onCategoryChange($event)">
        </app-filtros-catalogo>

        <div class="product-grid">
          <app-cartao-produto
            *ngFor="let p of products"
            [product]="p"
            (add)="addToCart($event)">
          </app-cartao-produto>
        </div>
      </section>

      <!-- CARRINHO -->
      <section class="panel" *ngIf="activeTab==='cart'">
        <div class="panel-head">
          <div>
            <p class="eyebrow">Pagamento</p>
            <h2>Carrinho e checkout</h2>
            <p>Importante: Caso deseje devolver algum produto, você tem o prazo de 7 dias a partir do momento da compra! Entre em contato diretamente com a loja: (68) 99999-9999</p>
          </div>
          <button class="btn ghost" (click)="clearCart()">Esvaziar</button>
        </div>
        <div class="cart-wrap">
          <app-itens-carrinho
            [cartItems]="cartItems"
            (qtyChange)="updateQty($event.id, $event.qty)"
            (removeItem)="removeItem($event)">
          </app-itens-carrinho>

          <app-resumo-checkout
            [itemsCount]="cartItems.length"
            [cartTotal]="cartTotal"
            [deliveryFee]="deliveryFee"
            [totalWithDelivery]="totalWithDelivery"
            [retirada]="checkoutForm.retirada"
            [nome]="checkoutForm.nome"
            [email]="checkoutForm.email"
            [rua]="checkoutForm.rua"
            [cidade]="checkoutForm.cidade"
            [estado]="checkoutForm.estado"
            [cep]="checkoutForm.cep"
            [metodoPagamento]="checkoutForm.metodoPagamento"
            [formError]="formError"
            (retiradaChange)="setRetirada($event)"
            (nomeChange)="setNome($event)"
            (emailChange)="setEmail($event)"
            (ruaChange)="setRua($event)"
            (cidadeChange)="setCidade($event)"
            (estadoChange)="setEstado($event)"
            (cepChange)="setCep($event)"
            (metodoPagamentoChange)="setMetodoPagamento($event)"
            (checkout)="checkout()">
          </app-resumo-checkout>
        </div>
      </section>

      <!-- PEDIDOS -->
      <section class="panel" *ngIf="activeTab==='orders'">
        <div class="panel-head">
          <div>
            <p class="eyebrow">Histórico</p>
            <h2>Pedidos simulados</h2>
          </div>
          <button class="btn ghost" (click)="loadOrders()">Atualizar</button>
        </div>
        <app-lista-pedidos [orders]="orders" (viewPayment)="openPaymentModalFromOrder($event)"></app-lista-pedidos>
      </section>

      <!-- PERFIL -->
      <section class="panel" *ngIf="activeTab==='profile'">
        <div class="panel-head">
          <div>
            <p class="eyebrow">Conta</p>
            <h2>Perfil e preferências</h2>
          </div>
        </div>
        <ng-container *ngIf="user; else authPrompt">
          <div class="card stack">
            <div class="row">
              <h3>Dados de contato e entrega</h3>
              <span class="pill muted">Aplicado no checkout</span>
            </div>
            <div class="field-grid">
              <label>Nome completo
                <input [(ngModel)]="contactForm.name" placeholder="Seu nome">
              </label>
              <label>Email
                <input type="email" [(ngModel)]="contactForm.email" placeholder="email@exemplo.com">
              </label>
              <label>Rua / número
                <input [(ngModel)]="contactForm.street" placeholder="Av. Exemplo, 123">
              </label>
              <label>Cidade
                <input [(ngModel)]="contactForm.city" placeholder="São Paulo">
              </label>
              <label>Estado
                <input [(ngModel)]="contactForm.state" placeholder="SP">
              </label>
              <label>CEP
                <input [(ngModel)]="contactForm.zip" placeholder="00000-000">
              </label>
            </div>
            <div class="row">
              <button class="btn primary" (click)="saveProfileContact()">Salvar dados</button>
              <span class="muted tiny">Gravamos no navegador para preencher o checkout automaticamente.</span>
            </div>
            <p class="muted danger" *ngIf="profileError">{{profileError}}</p>
          </div>

        </ng-container>

        <ng-template #authPrompt>
          <div class="card stack auth-cta">
            <p class="eyebrow">Acesso</p>
            <h3>Entre para ver seu perfil</h3>
            <p class="muted">Faça login para acessar pedidos, dados salvos e cadastro de pets. Se ainda não tem conta, cadastre-se em segundos.</p>
            <div class="row">
              <button class="btn primary" (click)="openLoginModal()">Entrar</button>
              <button class="btn ghost" (click)="openSignupModal()">Criar conta</button>
            </div>
          </div>
        </ng-template>
      </section>

      <!-- ADMIN -->
      <section class="panel" *ngIf="activeTab==='admin' && isAdmin">
        <div class="panel-head">
          <div>
            <p class="eyebrow">Painel</p>
            <h2>Administração</h2>
          </div>
        </div>

        <app-formulario-produto-admin
          [product]="adminProduct"
          [products]="products"
          [categories]="categories"
          (refresh)="loadProducts()"
          (select)="adminProduct=$event"
          (save)="adminProduct=$event; saveProduct()"
          (remove)="deleteProduct($event)">
        </app-formulario-produto-admin>

        <div class="admin-duo">
          <app-painel-categoria-admin
            [category]="adminCategory"
            [categories]="categories"
            (save)="adminCategory=$event; saveCategory()"
            (remove)="deleteCategory($event)"
            (refresh)="loadCategories()">
          </app-painel-categoria-admin>
        </div>

        <app-painel-pedidos-admin
          [orders]="orders"
          (refresh)="loadOrders()">
        </app-painel-pedidos-admin>
      </section>
    </main>
  </div>

  <app-modal-login
    [visible]="loginModal"
    [email]="loginForm.email"
    [senha]="loginForm.senha"
    (login)="loginForm = { email: $event.email, senha: $event.senha }; login(); closeAuthModals()"
    (close)="closeAuthModals()"
    (openSignup)="openSignupModal()">
  </app-modal-login>

  <app-modal-signup
    [visible]="signupModal"
    [name]="signupForm.nome"
    [email]="signupForm.email"
    [password]="signupForm.senha"
    (signup)="signupForm = { nome: $event.nome, email: $event.email, senha: $event.senha }; signup(); closeAuthModals()"
    (close)="closeAuthModals()"
    (openLogin)="openLoginModal()">
  </app-modal-signup>
</div>
