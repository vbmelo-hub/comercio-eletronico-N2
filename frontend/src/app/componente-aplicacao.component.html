<div class="estrutura">
  <nav class="barra-navegacao">
    <div class="marca">
      <div class="marca-selo">AP</div>
      <div>
        <p class="sobrancelha">Artemis Pets</p>
        <strong>Loja completa para seu pet</strong>
      </div>
    </div>

    <div class="links-navegacao">
      <button class="botao-navegacao" [class.ativo]="activeTab==='catalog'" (click)="setTab('catalog')">Catalogo</button>
      <button class="botao-navegacao" [class.ativo]="activeTab==='cart'" (click)="setTab('cart')">Carrinho</button>
      <button class="botao-navegacao" [class.ativo]="activeTab==='orders'" (click)="setTab('orders')">Pedidos</button>
      <button class="botao-navegacao" [class.ativo]="activeTab==='profile'" (click)="setTab('profile')">Perfil</button>
      <button class="botao-navegacao" *ngIf="isAdmin" [class.ativo]="activeTab==='admin'" (click)="setTab('admin')">Administracao</button>
    </div>

    <div class="usuario-navegacao">
      <span class="selo" *ngIf="user; else guest">{{user?.nome}} / {{roleLabel(user?.papel)}}</span>
      <ng-template #guest><span class="selo suave">Visitante</span></ng-template>
      <button class="botao fantasma" *ngIf="!user" (click)="openLoginModal()">Entrar</button>
      <button class="botao fantasma perigo" *ngIf="user" (click)="logout()">Sair</button>
    </div>
  </nav>

  <div class="estado" *ngIf="statusMessage">{{statusMessage}}</div>
  <div class="aviso" *ngIf="toast" [class.erro]="toast.type==='error'">{{toast.message}}</div>

  <main>
    <!-- CATALOGO -->
    <section *ngIf="activeTab==='catalog'" class="painel painel-catalogo">
      <div class="cabecalho-painel">
        <div>
          <p class="sobrancelha">Produtos</p>
          <h2>Catalogo premium</h2>
        </div>
        <div class="selo suave">Itens disponiveis: {{products.length}}</div>
      </div>

      <app-filtros-catalogo
        [categories]="categories"
        [searchTerm]="searchTerm"
        [petFilter]="petFilter"
        [categoryFilter]="categoryFilter"
        (searchChange)="onSearch($event)"
        (petChange)="onPetChange($event)"
        (categoryChange)="onCategoryChange($event)">
      </app-filtros-catalogo>

      <div class="grade-produtos">
        <app-cartao-produto
          *ngFor="let p of products"
          [product]="p"
          (add)="addToCart($event)">
        </app-cartao-produto>
      </div>
    </section>

    <!-- CARRINHO -->
    <section class="painel" *ngIf="activeTab==='cart'">
      <div class="cabecalho-painel">
        <div>
          <p class="sobrancelha">Pagamento</p>
          <h2>Carrinho e pagamento</h2>
        </div>
        <button class="botao fantasma" (click)="clearCart()">Esvaziar</button>
      </div>
      <div class="conjunto-carrinho">
        <app-itens-carrinho
          [cartItems]="cartItems"
          (qtyChange)="updateQty($event.id, $event.qty)"
          (removeItem)="removeItem($event)">
        </app-itens-carrinho>

        <app-resumo-checkout
          [itemsCount]="cartItems.length"
          [cartTotal]="cartTotal"
          [deliveryFee]="deliveryFee"
          [totalWithDelivery]="totalWithDelivery"
          [cupom]="checkoutForm.cupom"
          [retirada]="checkoutForm.retirada"
          [nome]="checkoutForm.nome"
          [email]="checkoutForm.email"
          [rua]="checkoutForm.rua"
          [cidade]="checkoutForm.cidade"
          [estado]="checkoutForm.estado"
          [cep]="checkoutForm.cep"
          [metodoPagamento]="checkoutForm.metodoPagamento"
          [formError]="formError"
          (cupomChange)="checkoutForm.cupom = $event"
          (applyCoupon)="applyCoupon()"
          (retiradaChange)="setRetirada($event)"
          (nomeChange)="setNome($event)"
          (emailChange)="setEmail($event)"
          (ruaChange)="setRua($event)"
          (cidadeChange)="setCidade($event)"
          (estadoChange)="setEstado($event)"
          (cepChange)="setCep($event)"
          (metodoPagamentoChange)="setMetodoPagamento($event)"
          (checkout)="checkout()">
        </app-resumo-checkout>
      </div>
    </section>

    <!-- PEDIDOS -->
    <section class="painel" *ngIf="activeTab==='orders'">
      <div class="cabecalho-painel">
        <div>
          <p class="sobrancelha">Historico</p>
          <h2>Pedidos simulados</h2>
        </div>
        <button class="botao fantasma" (click)="loadOrders()">Atualizar</button>
      </div>
      <app-lista-pedidos [orders]="orders" (viewPayment)="openPaymentModalFromOrder($event)"></app-lista-pedidos>
    </section>

    <!-- PERFIL -->
    <section class="painel" *ngIf="activeTab==='profile'">
      <div class="cabecalho-painel">
        <div>
          <p class="sobrancelha">Conta</p>
          <h2>Perfil e preferencias</h2>
        </div>
      </div>
      <ng-container *ngIf="user; else authPrompt">
        <div class="perfil-grade">
          <div class="cartao pilha destaque">
            <p class="sobrancelha">Resumo da conta</p>
            <h3>{{user?.nome}}</h3>
            <div class="estatisticas-compactas">
              <span class="selo suave">Email: {{user?.email}}</span>
              <span class="selo suave">Perfil: {{roleLabel(user?.papel)}}</span>
            </div>
            <div class="estatisticas-compactas">
              <span class="selo">Pets: {{user?.pets?.length || 0}}</span>
              <span class="selo">Pedidos: {{orders.length}}</span>
              <span class="selo">ID: #{{user?.id}}</span>
            </div>
            <p class="suave tiny">Use esses dados para agilizar o checkout e manter o historico organizado.</p>
          </div>

          <div class="cartao pilha">
            <div class="linha">
              <h3>Dados de contato e entrega</h3>
              <span class="selo suave">Aplicado no checkout</span>
            </div>
            <div class="grade-campos">
              <label>Nome completo
                <input [(ngModel)]="contactForm.nome" placeholder="Seu nome">
              </label>
              <label>Email
                <input type="email" [(ngModel)]="contactForm.email" placeholder="email@exemplo.com">
              </label>
              <label>Rua / numero
                <input [(ngModel)]="contactForm.rua" placeholder="Av. Exemplo, 123">
              </label>
              <label>Cidade
                <input [(ngModel)]="contactForm.cidade" placeholder="Sao Paulo">
              </label>
              <label>Estado
                <input [(ngModel)]="contactForm.estado" placeholder="SP">
              </label>
              <label>CEP
                <input [(ngModel)]="contactForm.cep" placeholder="00000-000">
              </label>
            </div>
            <div class="linha">
              <button class="botao primario" (click)="saveProfileContact()">Salvar dados</button>
              <span class="suave tiny">Gravamos no navegador para preencher o checkout automaticamente.</span>
            </div>
            <p class="suave perigo" *ngIf="profileError">{{profileError}}</p>
          </div>
        </div>

        <app-lista-pets
          [enabled]="!!user"
          [ownerName]="user?.nome || ''"
          [pets]="user?.pets || []"
          (add)="petForm = $event; addPet()">
        </app-lista-pets>
      </ng-container>

      <ng-template #authPrompt>
        <div class="cartao pilha cta-autenticacao">
          <p class="sobrancelha">Acesso</p>
          <h3>Entre para ver seu perfil</h3>
          <p class="suave">Faca login para acessar pedidos, dados salvos e cadastro de pets. Se ainda nao tem conta, cadastre-se em segundos.</p>
          <div class="linha">
            <button class="botao primario" (click)="openLoginModal()">Entrar</button>
            <button class="botao fantasma" (click)="openSignupModal()">Criar conta</button>
          </div>
        </div>
      </ng-template>
    </section>

    <!-- ADMIN -->
    <section class="painel" *ngIf="activeTab==='admin' && isAdmin">
      <div class="cabecalho-painel">
        <div>
          <p class="sobrancelha">Painel</p>
          <h2>Administracao</h2>
        </div>
      </div>

      <app-formulario-produto-admin
        [product]="adminProduct"
        [categories]="categories"
        (refresh)="loadProducts()"
        (save)="adminProduct=$event; saveProduct()">
      </app-formulario-produto-admin>

      <div class="dupla-admin">
        <app-painel-categoria-admin
          [category]="adminCategory"
          [categories]="categories"
          (save)="adminCategory=$event; saveCategory()"
          (remove)="deleteCategory($event)"
          (refresh)="loadCategories()">
        </app-painel-categoria-admin>

        <app-painel-cupom-admin
          [coupon]="couponForm"
          [coupons]="coupons"
          (save)="couponForm=$event; saveCoupon()"
          (refresh)="loadCoupons()">
        </app-painel-cupom-admin>
      </div>

      <app-painel-pedidos-admin
        [orders]="orders"
        (refresh)="loadOrders()">
      </app-painel-pedidos-admin>
    </section>
  </main>

  <div class="fundo-modal" *ngIf="paymentModal">
    <div class="cartao-modal">
      <div class="linha cabecalho-modal">
        <h3>Pagamento</h3>
        <button class="botao fantasma perigo fechar-modal" (click)="paymentModal=false" aria-label="Fechar modal">X</button>
      </div>
      <p class="suave" *ngIf="paymentDetails">{{paymentDetails?.info}}</p>
      <div *ngIf="paymentDetails?.chavePix">
        <div class="linha">
          <span>Chave PIX:</span>
          <strong>{{paymentDetails.chavePix}}</strong>
        </div>
        <img *ngIf="paymentDetails.qrCodeUrl" [src]="paymentDetails.qrCodeUrl" alt="QR Code PIX" class="codigo-qr">
        <button class="botao primario cheio" (click)="copyPix(paymentDetails.chavePix)">Copiar chave</button>
      </div>
      <div *ngIf="paymentDetails?.boleto">
        <div class="linha">
          <span>Boleto:</span>
          <strong>{{paymentDetails.boleto}}</strong>
        </div>
        <p class="suave tiny">Pague em ate 48h.</p>
      </div>
    </div>
  </div>

  <div class="fundo-modal" *ngIf="loginModal">
    <div class="cartao-modal modal-autenticacao">
      <div class="linha cabecalho-modal">
        <div>
          <p class="sobrancelha">Acesso seguro</p>
          <h3>Entrar</h3>
        </div>
        <button class="botao fantasma perigo fechar-modal" (click)="closeAuthModals()" aria-label="Fechar modal">X</button>
      </div>
      <p class="suave tiny">Use seu email e senha para continuar.</p>
      <app-painel-login
        [email]="loginForm.email"
        [senha]="loginForm.senha"
        (login)="loginForm = { email: $event.email, senha: $event.senha }; login(); closeAuthModals()">
      </app-painel-login>
      <div class="linha">
        <span class="suave tiny">Ainda nao tem conta?</span>
        <button class="botao fantasma" (click)="openSignupModal()">Criar conta</button>
      </div>
    </div>
  </div>

  <div class="fundo-modal" *ngIf="signupModal">
    <div class="cartao-modal modal-autenticacao">
      <div class="linha cabecalho-modal">
        <div>
          <p class="sobrancelha">Cadastro</p>
          <h3>Criar conta</h3>
        </div>
        <button class="botao fantasma perigo fechar-modal" (click)="closeAuthModals()" aria-label="Fechar modal">X</button>
      </div>
      <p class="suave tiny">Ganhe historico, cupons e cadastro de pets.</p>
      <app-painel-cadastro
        [nome]="signupForm.nome"
        [email]="signupForm.email"
        [senha]="signupForm.senha"
        (signup)="signupForm = { nome: $event.nome, email: $event.email, senha: $event.senha }; signup(); closeAuthModals()">
      </app-painel-cadastro>
      <div class="linha">
        <span class="suave tiny">Ja tem conta?</span>
        <button class="botao fantasma" (click)="openLoginModal()">Entrar</button>
      </div>
    </div>
  </div>
</div>
