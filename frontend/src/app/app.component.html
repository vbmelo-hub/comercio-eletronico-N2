<div class="layout">
  <nav class="navbar">
    <div class="brand">
      <div class="brand-mark">AP</div>
      <div>
        <p class="eyebrow">Artemis Pets</p>
        <strong>Loja completa para seu pet</strong>
      </div>
    </div>

    <div class="nav-links">
      <button class="nav-btn" [class.active]="activeTab==='catalog'" (click)="setTab('catalog')">Catalogo</button>
      <button class="nav-btn" [class.active]="activeTab==='cart'" (click)="setTab('cart')">Carrinho</button>
      <button class="nav-btn" [class.active]="activeTab==='orders'" (click)="setTab('orders')">Pedidos</button>
      <button class="nav-btn" [class.active]="activeTab==='profile'" (click)="setTab('profile')">Perfil</button>
      <button class="nav-btn" *ngIf="isAdmin" [class.active]="activeTab==='admin'" (click)="setTab('admin')">Admin</button>
    </div>

    <div class="nav-user">
      <span class="pill" *ngIf="user; else guest">{{user?.name}} Â· {{user?.role}}</span>
      <ng-template #guest><span class="pill muted">Visitante</span></ng-template>
      <button class="btn ghost" *ngIf="!user" (click)="setTab('profile')">Entrar</button>
      <button class="btn ghost danger" *ngIf="user" (click)="logout()">Sair</button>
    </div>
  </nav>

  <div class="status" *ngIf="statusMessage">{{statusMessage}}</div>
  <div class="toast" *ngIf="toast" [class.error]="toast.type==='error'">{{toast.message}}</div>

  <main>
    <!-- CATALOGO -->
    <section *ngIf="activeTab==='catalog'" class="panel catalog-panel">
      <div class="panel-head">
        <div>
          <p class="eyebrow">Produtos</p>
          <h2>Catalogo premium</h2>
        </div>
        <div class="pill muted">Itens disponiveis: {{products.length}}</div>
      </div>

      <app-catalog-filters
        [categories]="categories"
        [searchTerm]="searchTerm"
        [petFilter]="petFilter"
        [categoryFilter]="categoryFilter"
        (searchChange)="onSearch($event)"
        (petChange)="onPetChange($event)"
        (categoryChange)="onCategoryChange($event)">
      </app-catalog-filters>

      <div class="product-grid">
        <app-product-card
          *ngFor="let p of products"
          [product]="p"
          (add)="addToCart($event)">
        </app-product-card>
      </div>
    </section>

    <!-- CARRINHO -->
    <section class="panel" *ngIf="activeTab==='cart'">
      <div class="panel-head">
        <div>
          <p class="eyebrow">Checkout</p>
          <h2>Carrinho e pagamento</h2>
        </div>
        <button class="btn ghost" (click)="clearCart()">Esvaziar</button>
      </div>
      <div class="cart-wrap">
        <app-cart-items
          [cartItems]="cartItems"
          (qtyChange)="updateQty($event.id, $event.qty)"
          (removeItem)="removeItem($event)">
        </app-cart-items>

        <app-checkout-summary
          [itemsCount]="cartItems.length"
          [cartTotal]="cartTotal"
          [deliveryFee]="deliveryFee"
          [totalWithDelivery]="totalWithDelivery"
          [coupon]="checkoutForm.coupon"
          [pickup]="checkoutForm.pickup"
          [name]="checkoutForm.name"
          [email]="checkoutForm.email"
          [street]="checkoutForm.street"
          [city]="checkoutForm.city"
          [state]="checkoutForm.state"
          [zip]="checkoutForm.zip"
          [paymentMethod]="checkoutForm.paymentMethod"
          [formError]="formError"
          (couponChange)="checkoutForm.coupon = $event"
          (applyCoupon)="applyCoupon()"
          (pickupChange)="setPickup($event)"
          (nameChange)="setName($event)"
          (emailChange)="setEmail($event)"
          (streetChange)="setStreet($event)"
          (cityChange)="setCity($event)"
          (stateChange)="setState($event)"
          (zipChange)="setZip($event)"
          (paymentMethodChange)="setPaymentMethod($event)"
          (checkout)="checkout()">
        </app-checkout-summary>
      </div>
    </section>

    <!-- PEDIDOS -->
    <section class="panel" *ngIf="activeTab==='orders'">
      <div class="panel-head">
        <div>
          <p class="eyebrow">Historico</p>
          <h2>Pedidos simulados</h2>
        </div>
        <button class="btn ghost" (click)="loadOrders()">Atualizar</button>
      </div>
      <app-order-list [orders]="orders" (viewPayment)="openPaymentModalFromOrder($event)"></app-order-list>
    </section>

    <!-- PERFIL -->
    <section class="panel" *ngIf="activeTab==='profile'">
      <div class="panel-head">
        <div>
          <p class="eyebrow">Conta</p>
          <h2>Login, cadastro e pets</h2>
        </div>
      </div>
      <div class="split">
        <app-login-panel
          [email]="loginForm.email"
          [password]="loginForm.password"
          (login)="loginForm = { email: $event.email, password: $event.password }; login()">
        </app-login-panel>
        <app-signup-panel
          [name]="signupForm.name"
          [email]="signupForm.email"
          [password]="signupForm.password"
          (signup)="signupForm = { name: $event.name, email: $event.email, password: $event.password }; signup()">
        </app-signup-panel>
      </div>

      <app-pet-list
        *ngIf="user"
        [enabled]="!!user"
        [ownerName]="user?.name || ''"
        [pets]="user?.pets || []"
        (add)="petForm = $event; addPet()">
      </app-pet-list>
    </section>

    <!-- ADMIN -->
    <section class="panel" *ngIf="activeTab==='admin' && isAdmin">
      <div class="panel-head">
        <div>
          <p class="eyebrow">Painel</p>
          <h2>Administracao</h2>
        </div>
      </div>

      <app-admin-product-form
        [product]="adminProduct"
        [categories]="categories"
        (refresh)="loadProducts()"
        (save)="adminProduct=$event; saveProduct()">
      </app-admin-product-form>

      <div class="admin-duo">
        <app-admin-category-panel
          [category]="adminCategory"
          [categories]="categories"
          (save)="adminCategory=$event; saveCategory()"
          (remove)="deleteCategory($event)"
          (refresh)="loadCategories()">
        </app-admin-category-panel>

        <app-admin-coupon-panel
          [coupon]="couponForm"
          [coupons]="coupons"
          (save)="couponForm=$event; saveCoupon()"
          (refresh)="loadCoupons()">
        </app-admin-coupon-panel>
      </div>

      <app-admin-orders-panel
        [orders]="orders"
        (refresh)="loadOrders()">
      </app-admin-orders-panel>
    </section>
  </main>

  <div class="modal-backdrop" *ngIf="paymentModal">
    <div class="modal-card">
      <div class="row">
        <h3>Pagamento</h3>
        <button class="btn ghost danger" (click)="paymentModal=false">Fechar</button>
      </div>
      <p class="muted" *ngIf="paymentDetails">{{paymentDetails?.info}}</p>
      <div *ngIf="paymentDetails?.pixKey">
        <div class="row">
          <span>Chave PIX:</span>
          <strong>{{paymentDetails.pixKey}}</strong>
        </div>
        <img *ngIf="paymentDetails.qrCodeUrl" [src]="paymentDetails.qrCodeUrl" alt="QR Code PIX" class="qr">
        <button class="btn primary full" (click)="copyPix(paymentDetails.pixKey)">Copiar chave</button>
      </div>
      <div *ngIf="paymentDetails?.boleto">
        <div class="row">
          <span>Boleto:</span>
          <strong>{{paymentDetails.boleto}}</strong>
        </div>
        <p class="muted tiny">Pague em ate 48h.</p>
      </div>
    </div>
  </div>
</div>
